<% content_for :head do %>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script src="/javascripts/jquery.ui.map.js" type="text/javascript"></script>

  <script type="text/javascript">
    $(function() {
      $('#map_canvas').gmap({ 'center': new google.maps.LatLng(37.4419, 0), 'zoom': 2, 'streetViewControl': false, 'callback': function (map) {
        $.get('/map/newmap_feed.xml', function(xml_data) {
        	var entries_by_lat_comma_lng = new Array();

          //  Parse XML feed, store entry info in global array 'entries_by_lat_comma_lng'
          $('listings', xml_data).children('listing').each(function() {
            var latitude  = $('latitude', this).text();
            var longitude = $('longitude', this).text();
            var lat_comma_lng = latitude + ',' + longitude;

            if (!(lat_comma_lng in entries_by_lat_comma_lng)) {
              entries_by_lat_comma_lng[lat_comma_lng] = new Array();
            } 
            entries_by_lat_comma_lng[lat_comma_lng].push({
              'title': $('title', this).text()
              //  TODO: Add more fields here
            });
          });

          //  Add a Marker for each GPS coordinate
          for (var lat_comma_lng in entries_by_lat_comma_lng) {
            var latlng = lat_comma_lng.split(',');
            var total_entries = entries_by_lat_comma_lng[lat_comma_lng].length;
            
            $('#map_canvas').gmap('addMarker', {
              'position': new google.maps.LatLng(latlng[0], latlng[1]),
              'icon':new google.maps.MarkerImage(marker_image_url_for_n_entries(total_entries)),

              //  Attach the array of entries for the GPS coordinate to the Marker object
              'contactimprov_entries': entries_by_lat_comma_lng[lat_comma_lng]
            }).click(function() {
              var latlng = $(this).get(0).getPosition();
              map.panTo(latlng);
              show_dialog($(this).get(0).contactimprov_entries);
            });
          }

        }, 'xml');
      }});

      function show_dialog(entries) {
        if (entries.length > 1) {
          var h = '';
          for (i in entries) {
            h += '<h3><a href="#">' + entries[i].title + '</a></h3><div>Random Content</div>';
          }
          $('<div></div>')
            .html(h)
            .dialog({'title': 'Multiple Entries'})
            .accordion();
        }
        else {
          $('<div></div>')
            .html('Testing')
            .dialog({'title': entries[0].title});
        }
      }

      function marker_image_url_for_n_entries(n) {
        //  The google-maps-icons project only has icons for numbers up to 20 for most of the
        //  colored numeric icon sets.  For the full list, see:
        //    http://code.google.com/p/google-maps-icons/wiki/NumericIcons
        if (n >= 20) {
          n = 20;
        }

        var zero_padded_n = (n < 10 ? '0' : '') + n;

        return 'http://google-maps-icons.googlecode.com/files/purple' + zero_padded_n + '.png';
      }
    });
  </script>
<% end %>

<div id="map_canvas" style="width: 100%; height: 500px; border: 1px solid #666;"></div>
